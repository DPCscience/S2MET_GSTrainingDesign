---
title: "Gather Environmental Variables"
output: html_notebook
bibliography: C:/Users/Jeff/Documents/Literature/library.bib
---

## Introduction

This notebook will walk through the process of cleaning, manipulating, and analyzing data that will serve as environmental covariables in the S2MET project 

```{r setup}

library(tidyverse)
library(stringr)
library(lubridate)
library(purrrlyr)

# Directory
proj_dir <- "C:/Users/Jeff/Google Drive/Barley Lab/Projects/S2MET/"

# Source the source script
source(file.path(proj_dir, "source.R"))

```



## Notes on Collecting Environmental Data

This database returns variables per horizon per component (these can be found in a description [here](https://sdmdataaccess.nrcs.usda.gov/documents/TableColumnDescriptionsReport.pdf)). The following variables will be kept:


  Variable      | Definition
----------------|---------------------------------------------------------------
hzdept_r        | Distance from top of soil to top of horizon (cm)
hzdepb_r        | Distance from top of soil to bottom of horizon (cm)
sandtotal_r     | Mineral particles 0.05mm to 2.0mm in equivalent diameter as a weight percentage of the less than 2 mm fraction.
silttotal_r     | Mineral particles 0.002 to 0.05mm in equivalent diameter as a weight percentage of the less than 2.0mm fraction.
claytotal_r     | Mineral particles less than 0.002mm in equivalent diameter as a weight percentage of the less than 2.0mm fraction.
om_r            | The amount by weight of organic matter expressed as a weight percentage of the less than 2 mm soil material
ph1to1h2o_r     | pH


Query the National Soil Database for site information in Canada

The analagous variables from the USDA Soil Survey in the National Soil DataBase (Canada) are:

  Variable      | NSDB Analogue
----------------|---------------------------------------------------------------
hzdept_r        | UDEPTH
hzdepb_r        | LDEPTH - UDEPTH
sandtotal_r     | TSAND
silttotal_r     | TSILT
claytotal_r     | TCLAY
om_r            | ORGCARB
ph1to1h2o_r     | PH2



### Transformation and Compilation 

Using a topsoil-subsoil cutoff of 20 cM


```{r transform}

# Load both climate and soil datasets
noaa_file <- file.path(env_var_dir, "Climate_Data/NOAA_Data/noaa_stations_trial_data.RData")
load(noaa_file)

soil_file <- file.path(env_var_dir, "Soil_Data/complete_trial_soil_data.RData")
load(soil_file)


```



Edits to soil data

```{r soil.edits}


## Soil data
# Edit the soil data (define topsoil and subsoil, then scale and center). Note in cm
depth_cutoff <- 20

# Create a function that calculates the the proportion of overlap given two ranges
range_overlap <- function(x, y) {
  is_engulfed <- between(x = y[1], x[1], x[2]) & between(x = y[2], x[1], x[2])
  if (is_engulfed) {
    return(1)
  } else if (between(x = y[1], x[1], x[2])) {
    (x[2] - y[1]) / diff(y)
  } else {
    return(0)
  }}

# Calculate the proportion of each layer within the topsoil
# Use a weighted mean of the proportion of each horizon within topsoil vs subsoil
# to calculate the value in each layer
soil_data_complete1 <- soil_data_complete %>% 
  rowwise() %>% 
  mutate(prop_subsoil = 1 - range_overlap(x = c(0, 20), y = c(hzdept_r, hzdepb_r))) %>%
  group_by(environment, location, variable) %>% 
  # Weight the mean value in each soil layer by the proportion of the horizon in
  # the layer
  summarize(subsoil = weighted.mean(x = value, w = prop_subsoil, na.rm = T), 
            topsoil = weighted.mean(x = value, w = 1 - prop_subsoil, na.rm = T)) %>%
  gather(layer, value, -environment:-variable) %>%
  # Center and scale
  unite(variable, variable, layer, sep = "_") %>%
  ungroup() %>%
  select(environment, variable, value)


```



Create summary environmental variables. We will use those outlined in @Anderson2016. Essentially, we will calculate the monthly min, mean, and max for temperature and precipitation. We will also calculate the min mean and max of one variables during the wettest/driest or the warmest/coldest month.

Use the USGS Bioclimatic Predictors for Supporting Ecological Applications in the Conterminous United States



```{r climate.summ}

# first unnest data and pull out the single environments
env_data_unnest <- noaa_trial_data_complete %>%
  unnest()

trial_env_data <- trial_info %>% 
  distinct(environment, location, year) %>%
  mutate_all(parse_guess) %>%
  left_join(., env_data_unnest)

# Summarize longitude/latitude
coord_clim_summ <- trial_env_data %>% 
  select(environment, latitude, longitude) %>% 
  gather(variable, value, -environment)

```


Calculate summary statistics for temperature and precip

First calculate some basic summary statistics:
- monthly mean of daily max temperature
- monthly mean of daily min temperature
- average monthly temperature ([Tmax + Tmin] / 2)
- total monthly precip


```{r summ.stats}

summ_stats_temp <- trial_env_data %>% 
  select(environment, date, month, datatype, value) %>% 
  filter(datatype != "PRCP") %>% 
  spread(datatype, value) %>% 
  group_by(environment, month) %>% 
  summarize_at(vars(TMAX, TMIN), mean, na.rm = TRUE) %>% 
  mutate(TAVG = (TMAX + TMIN) / 2) %>%
  gather(variable, value, -environment, -month)

summ_stats_prcp <- trial_env_data %>% 
  select(environment, date, month, datatype, value) %>% 
  filter(datatype == "PRCP") %>% group_by(environment, month) %>% 
  summarize(PPT = sum(value, na.rm = TRUE)) %>% 
  gather(variable, value, -environment, -month)

# Combine
mon_summ_stats <- bind_rows(summ_stats_temp, summ_stats_prcp) %>%
  mutate(month = str_c("month_", month)) %>% 
  unite(variable, month, variable, sep = "_")

```


Calculate secondary summary statistics
- annual mean temperature (average of monthly temperatures; we will rename this growing annual mean temperature
- annual mean diurnal range (average of the difference between monthly mean min and max temperatures; we will rename this growing annual mean diurnal range)
- Max temperature of warmest month (max TMAX)
- Min temperature of coldest month (min TMIN)
- Annual temperature range (max(TMAX) - min(TMIN); renamed growing annual temperature range)
- isothermality (annual mean diurnal range / Annual temperature range) * 100
- temperature seasonality (standard deviation of TAVG)
- Annual precipitation (sum of PPT; renamed growing annual precipitation)
- Precipitation of wettest month (max PPT)
- Precipitation of driest month (min PPT)


```{r sec.summ.stats}

# Annual mean temperature
annual_TAVG <- summ_stats_temp %>% 
  filter(variable == "TAVG") %>% 
  group_by(environment) %>% 
  summarize(annual_TAVG = mean(value, na.rm = TRUE), temp_seasonality = sd(value, na.rm = TRUE)) %>%
  gather(variable, value, -environment)

annual_diurnal_range <- summ_stats_temp %>% 
  filter(variable != "TAVG") %>% 
  spread(variable, value) %>% 
  group_by(environment) %>% 
  mutate(diurnal_range = TMAX - TMIN) %>% 
  summarize(annual_diurnal_range = mean(diurnal_range, na.rm = TRUE)) %>%
  gather(variable, value, -environment)

range_min_max <- summ_stats_temp %>% 
  filter(variable != "TAVG") %>% 
  spread(variable, value) %>% 
  group_by(environment) %>% 
  summarize(max_TMAX = max(TMAX, na.rm = TRUE), min_TMIN = min(TMIN, na.rm = TRUE)) %>% 
  mutate(annual_temperature_range = max_TMAX - min_TMIN) %>% 
  gather(variable, value, -environment)

isotherm <- bind_rows(annual_diurnal_range, 
                     filter(range_min_max, variable == "annual_temperature_range")) %>% 
  spread(variable, value) %>% 
  group_by(environment) %>% 
  summarize(isothermality = (annual_diurnal_range / annual_temperature_range) * 100) %>%
  gather(variable, value, -environment)

# Precipitation
annual_prcp <- summ_stats_prcp %>% 
  group_by(environment) %>% 
  summarize(annual_precipitation = sum(value, na.rm = TRUE), max_PPT = max(value, na.rm = TRUE),
            min_PPT = min(value, na.rm = TRUE)) %>% 
  gather(variable, value, -environment)



```


Combine the monthly and annual data

```{r combine.data}

one_year_summary_df <- bind_rows(mon_summ_stats, annual_TAVG, annual_diurnal_range, 
                                 range_min_max, isotherm, annual_prcp) %>%
  ungroup()
  
```



### 10-year average

Perform the same calculations over the 10-year average

```{r}

trial_env_data <- trial_info %>% 
  distinct(environment, location, year) %>%  
  rename(env_year = year) %>%
  mutate_all(parse_guess) %>%
  left_join(., env_data_unnest) %>%
  select(environment, date, env_year, year, month, datatype, value)

```

Calculate summary statistics for temperature and precip

First calculate some basic summary statistics:
- monthly mean of daily max temperature
- monthly mean of daily min temperature
- average monthly temperature ([Tmax + Tmin] / 2)
- total monthly precip


```{r summ.stats}

summ_stats_temp <- trial_env_data %>% 
  filter(datatype != "PRCP") %>% 
  spread(datatype, value) %>% 
  group_by(environment, env_year, year, month) %>% 
  summarize_at(vars(TMAX, TMIN), mean, na.rm = TRUE) %>% 
  mutate(TAVG = (TMAX + TMIN) / 2) %>%
  gather(variable, value, -environment, -env_year, -year, -month)

summ_stats_prcp <- trial_env_data %>% 
  filter(datatype == "PRCP") %>% 
  group_by(environment, env_year, year, month) %>%  
  summarize(PPT = sum(value, na.rm = TRUE)) %>% 
  gather(variable, value, -environment, -env_year, -year, -month)

# Combine
mon_summ_stats <- bind_rows(summ_stats_temp, summ_stats_prcp) %>%
  mutate(month = str_c("month_", month)) %>% 
  unite(variable, month, variable, sep = "_")

```


Calculate secondary summary statistics
- annual mean temperature (average of monthly temperatures; we will rename this growing annual mean temperature
- annual mean diurnal range (average of the difference between monthly mean min and max temperatures; we will rename this growing annual mean diurnal range)
- Max temperature of warmest month (max TMAX)
- Min temperature of coldest month (min TMIN)
- Annual temperature range (max(TMAX) - min(TMIN); renamed growing annual temperature range)
- isothermality (annual mean diurnal range / Annual temperature range) * 100
- temperature seasonality (standard deviation of TAVG)
- Annual precipitation (sum of PPT; renamed growing annual precipitation)
- Precipitation of wettest month (max PPT)
- Precipitation of driest month (min PPT)


```{r sec.summ.stats}

# Annual mean temperature
annual_TAVG <- summ_stats_temp %>% 
  filter(variable == "TAVG") %>% 
  group_by(environment, env_year, year) %>% 
  summarize(annual_TAVG = mean(value, na.rm = TRUE), temp_seasonality = sd(value, na.rm = TRUE)) %>%
  gather(variable, value, -environment:-year)

annual_diurnal_range <- summ_stats_temp %>% 
  filter(variable != "TAVG") %>% 
  spread(variable, value) %>% 
  group_by(environment, env_year, year) %>% 
  mutate(diurnal_range = TMAX - TMIN) %>% 
  summarize(annual_diurnal_range = mean(diurnal_range, na.rm = TRUE)) %>%
  gather(variable, value, -environment:-year)

range_min_max <- summ_stats_temp %>% 
  filter(variable != "TAVG") %>% 
  spread(variable, value) %>% 
  group_by(environment, env_year, year) %>% 
  summarize(max_TMAX = max(TMAX, na.rm = TRUE), min_TMIN = min(TMIN, na.rm = TRUE)) %>% 
  mutate(annual_temperature_range = max_TMAX - min_TMIN) %>% 
  gather(variable, value, -environment:-year)

isotherm <- bind_rows(annual_diurnal_range, 
                     filter(range_min_max, variable == "annual_temperature_range")) %>% 
  spread(variable, value) %>% 
  group_by(environment, env_year, year) %>% 
  summarize(isothermality = (annual_diurnal_range / annual_temperature_range) * 100) %>%
  gather(variable, value, -environment:-year)

# Precipitation
annual_prcp <- summ_stats_prcp %>% 
  group_by(environment, env_year, year) %>% 
  summarize(annual_precipitation = sum(value, na.rm = TRUE), 
            max_PPT = max(value, na.rm = TRUE), min_PPT = min(value, na.rm = TRUE)) %>% 
  gather(variable, value, -environment:-year)



```


Combine the monthly and annual data

```{r combine.data}

multi_year_summary_df <- bind_rows(mon_summ_stats, annual_TAVG, annual_diurnal_range, 
                                   range_min_max, isotherm, annual_prcp) %>%
  # Summarize over the 10-year average
  ungroup() %>% 
  filter(year >= env_year - 10, year <= env_year - 1) %>% 
  group_by(environment, variable) %>%
  summarize(value = mean(value, na.rm = TRUE)) %>%
  ungroup()
  
```


## Combine climate and soil data


```{r combine.all}

# Replace NA with the variable mean across environments
one_year_env_df <- bind_rows(one_year_summary_df, soil_data_complete1) %>%
  group_by(variable) %>% 
  mutate(value = ifelse(is.na(value), mean(value, na.rm = TRUE), value)) %>% 
  ungroup()

multi_year_env_df <- bind_rows(multi_year_summary_df, soil_data_complete1) %>%
  group_by(variable) %>% 
  mutate(value = ifelse(is.na(value), mean(value, na.rm = TRUE), value)) %>% 
  ungroup()

# Convert to matrices
one_year_env_mat <- one_year_env_df %>% 
  spread(variable, value) %>% 
  as.data.frame() %>%
  remove_rownames() %>%
  column_to_rownames("environment") %>% 
  as.matrix()

multi_year_env_mat <- multi_year_env_df %>% 
  spread(variable, value) %>% 
  as.data.frame() %>%
  remove_rownames() %>%
  column_to_rownames("environment") %>% 
  as.matrix()


```


Save the data

```{r save}

# Save the data
save_file <- file.path(env_var_dir, "environmental_data_compiled.RData")
save("one_year_env_df", "multi_year_env_df", "one_year_env_mat", "multi_year_env_mat", file = save_file)


```


### PCA

Assess the relationship between environment using PCA

```{r env.PCA}

# Load data
load_file <- file.path(env_var_dir, "environmental_data_compiled.RData")
load(load_file)

## Try some PCA
# One-year
one_year_pca <- prcomp(t(one_year_env_mat))
# Lambda
lambda <- one_year_pca$sdev %>% 
  {. / sum(.)}

one_year_pca_tidy <- one_year_pca$rotation %>% 
  data.frame(environment = row.names(one_year_env_mat), .)

g1 <- full_join(trial_info, one_year_pca_tidy) %>% 
  mutate(year = as.factor(year)) %>%
  ggplot(aes(x = PC1, y = PC2, col = year)) + 
  geom_point() +
  geom_text(aes(label = environment), nudge_x = -0.01, nudge_y = -0.01) +
  ylab(paste("PC2 (", round(lambda[2]*100, 3), "%)", sep = "")) +
  xlab(paste("PC1 (", round(lambda[1]*100, 3), "%)", sep = "")) +
  labs( title = "PCA of Year-Specific Environmental Variables")

# Save image
save_file <- file.path(fig_dir, "one_year_env_data_pca.jpg")
ggsave(filename = save_file, plot = g1, height = 5, width = 7)


# Multi-year
multi_year_pca <- prcomp(t(multi_year_env_mat))
# Lambda
lambda <- multi_year_pca$sdev %>% 
  {. / sum(.)}

multi_year_pca_tidy <- multi_year_pca$rotation %>% 
  data.frame(environment = row.names(multi_year_env_mat), .)

g2 <- full_join(trial_info, multi_year_pca_tidy) %>% 
  mutate(year = as.factor(year)) %>%
  ggplot(aes(x = PC1, y = PC2, col = year)) + 
  geom_point() +
  geom_text(aes(label = environment), nudge_x = -0.01, nudge_y = -0.01) +
  ylab(paste("PC2 (", round(lambda[2]*100, 3), "%)", sep = "")) +
  xlab(paste("PC1 (", round(lambda[1]*100, 3), "%)", sep = "")) +
  labs( title = "PCA of 10-Year Average Environmental Variables")

save_file <- file.path(fig_dir, "multi_year_env_data_pca.jpg")
ggsave(filename = save_file, plot = g2, height = 5, width = 7)

```



